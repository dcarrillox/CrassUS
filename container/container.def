Bootstrap: docker
From: continuumio/miniconda3

%labels
	Author dcarrillox
	Maintainer and edits dcarrillox
	Version 0.1

%files
  prodigal
  profiles
  genomes
  container.yml
	fastANI
	all_crass_proteins.faa
	crass_reference_TerL.mafft-einsi

%post
  # update OS
  apt update && apt upgrade -y

  # create dirs for data and software
  mkdir data && mv profiles genomes all_crass_proteins.faa crass_reference_TerL.mafft-einsi data
  mkdir software && mv prodigal fastANI container.yml software

  # update conda
  conda config --add channels conda-forge
  conda config --add channels default
  conda config --add channels bioconda
  conda config --add channels r
  conda update -y conda

  # create env
  conda env create --name container -f software/container.yml
	conda clean --all -y

	# do the conda init
	echo ". /opt/conda/etc/profile.d/conda.sh" >> $SINGULARITY_ENVIRONMENT
	echo "conda activate container" >> $SINGULARITY_ENVIRONMENT
	. /opt/conda/etc/profile.d/conda.sh

	# FastANI dependency
	apt install libgomp1
	/software/fastANI -h

  # activate the env
  conda activate container

  # create blastdb for the crass_genomes
  #cat /data/genomes/*.fasta > /data/genomes/all_genomes.fasta
  #makeblastdb -in /data/genomes/all_genomes.fasta -out /data/genomes/all_genomes -dbtype nucl
